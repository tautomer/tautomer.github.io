---
layout: post
title: 'On a "silent shape bug": A bug goes unnoticed due to broadcasting'
description: A numerical bug from broadcasting in my algorithm went unnoticed for weeks caused by a wrong call of squeeze(). Instead of an element-wise addition, the operation was silently broadcasted, producing an incorrect but programmatically valid result. The bug was only discovered when an edge case with a zero-valued tensor made the output obviously incorrect... Luckily, I caught it before it is too later.
tags:
- Machine Learning
- Coding
- Python
- Torch
---

<section>
 <section>
  <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
   <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
     <div class="jp-InputPrompt jp-InputArea-prompt">
     </div>
     <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <h1 id="On-a-%22silent-shape-bug%22:-A-bug-goes-unnoticed-due-to-broadcasting">
       On a "silent shape bug": A bug goes unnoticed due to broadcasting
       <a class="anchor-link" href="#On-a-%22silent-shape-bug%22:-A-bug-goes-unnoticed-due-to-broadcasting"><i class="fa-solid fa-sm fa-link"></i></a>
      </h1>
     </div>
    </div>
   </div>
  </div>
  <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
   <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
     <div class="jp-InputPrompt jp-InputArea-prompt">
     </div>
     <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Ok, let's do a quick post on an annoying bug I encountered today.</p>
      <p>Recently, I have been working on some algorithms for Bayesian optimization. As I
have been extensively benchmarking my new implementations against existing
methods, I noticed a strange behavior. In a certain setup, the output of the
function is completely horizontal, which by no means is the expected behavior.</p>
      <p>I was absolutely clueless initially, as I have been working on this code for
several weeks and the results were generally good. After hours of debugging, I
realized the problem was due to a mismatch in the shapes of two tensors
introduced by a wrong call of <code>squeeze()</code>.</p>
     </div>
    </div>
   </div>
  </div>
  <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
   <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
     <div class="jp-InputPrompt jp-InputArea-prompt">
     </div>
     <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <h2 id="Demonstration-of-the-unexpected-broadcasting">
       Demonstration of the unexpected broadcasting
       <a class="anchor-link" href="#Demonstration-of-the-unexpected-broadcasting"><i class="fa-solid fa-sm fa-link"></i></a>
      </h2>
     </div>
    </div>
   </div>
  </div>
  <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
   <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
     <div class="jp-InputPrompt jp-InputArea-prompt">
     </div>
     <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Say I have two tensors <code>x</code> and <code>y</code>. Both are two-dimensional with the same
shape. At the end of the numerical expression, we reduce the last dimension by
taking the mean value along that dimension.</p>
     </div>
    </div>
   </div>
  </div>
  <div class="jp-Cell jp-CodeCell jp-Notebook-cell">
   <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
     <div class="jp-InputPrompt jp-InputArea-prompt">
      In [1]:
     </div>
     <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
      <div class="cm-editor cm-s-jupyter">
       <div class="highlight hl-ipython3">
        <pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"x: </span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"y: </span><span class="si">{</span><span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"z: </span><span class="si">{</span><span class="n">z</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"w: </span><span class="si">{</span><span class="n">w</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
     <div class="jp-OutputArea-child">
      <div class="jp-OutputPrompt jp-OutputArea-prompt">
      </div>
      <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
       <pre>x: torch.Size([10, 1])
y: torch.Size([10, 1])
z: torch.Size([10, 1])
w: torch.Size([10])
</pre>
      </div>
     </div>
    </div>
   </div>
  </div>
  <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
   <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
     <div class="jp-InputPrompt jp-InputArea-prompt">
     </div>
     <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>We simply do an element-wise addition of <code>x</code> and <code>y</code>, and then take the mean
along the last dimension. The final result <code>w</code> should be a one-dimensional
tensor.</p>
      <p>Now, let's assume we <em>mildly</em> screw up a little bit in the dimensionalities.</p>
     </div>
    </div>
   </div>
  </div>
  <div class="jp-Cell jp-CodeCell jp-Notebook-cell">
   <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
     <div class="jp-InputPrompt jp-InputArea-prompt">
      In [2]:
     </div>
     <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
      <div class="cm-editor cm-s-jupyter">
       <div class="highlight hl-ipython3">
        <pre><span></span><span class="n">x2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">y2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">z2</span> <span class="o">=</span> <span class="n">x2</span> <span class="o">+</span> <span class="n">y2</span>
<span class="n">w2</span> <span class="o">=</span> <span class="n">z2</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"x2: </span><span class="si">{</span><span class="n">x2</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"y2: </span><span class="si">{</span><span class="n">y2</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"z2: </span><span class="si">{</span><span class="n">z2</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"w2: </span><span class="si">{</span><span class="n">w2</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
</pre>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell-outputWrapper">
    <div class="jp-Collapser jp-OutputCollapser jp-Cell-outputCollapser">
    </div>
    <div class="jp-OutputArea jp-Cell-outputArea">
     <div class="jp-OutputArea-child">
      <div class="jp-OutputPrompt jp-OutputArea-prompt">
      </div>
      <div class="jp-RenderedText jp-OutputArea-output" data-mime-type="text/plain">
       <pre>x2: torch.Size([10])
y2: torch.Size([10, 1])
z2: torch.Size([10, 10])
w2: torch.Size([10])
</pre>
      </div>
     </div>
    </div>
   </div>
  </div>
  <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
   <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
     <div class="jp-InputPrompt jp-InputArea-prompt">
     </div>
     <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>Because <code>x2</code> is only one-dimensional, <code>z2 = x2 + y2</code> becomes a broadcasted addition,
instead of element-wise. While the resulting tensor <code>z2</code> has a wrong shape of
(10, 10), the next step is immediately a dimension reduction, which produces a
tensor <code>w2</code> of the current shape. However, the math behind is completely wrong.</p>
      <p>Because this broadcasted version is programmingly valid, no error is raised. As
for the numerical side, it is hard to notice as well.</p>
      <p>The fist version,</p>
      <p>$$w_i = x_i + y_i$$</p>
      <p>While the second version,</p>
      <p>$$w2_i = y2_i + \bar{x2}$$</p>
      <p>Apparently, the difference can be small, when one tensor is dominating or <code>x</code> is
close to degenerate. Especially in the context of Bayesian optimization, lots of
tensor operations are involved, and the "correct" values are not immediately
clear to the user. To make it worse, many tensors are not explicitly exposed to
the user unless the user is digging into the code. All in all, there is no easy
way to tell the numbers are numerically wrong.</p>
      <p>I was lucky enough that I was dealing with an edge case where <code>y</code> is 0, so
instead of getting <code>w = x</code>, I got <code>w2 = mean(x)</code>, whose elements are a constant
value. This was way too obvious that something was wrong.</p>
      <p>As for the root cause? A wrong call of <code>squeeze()</code> in another function.</p>
      <div class="highlight">
       <pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>

<span class="k">def</span><span class="w"> </span><span class="nf">some_func</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="c1"># do something here</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="c1"># some dozens of lines of code here</span>


<span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">x_new</span> <span class="o">=</span> <span class="n">some_func</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># x_new has shape (10,)</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre>
      </div>
      <p>I was happily assuming <code>x_new</code> was still of shape (10, 1) for weeks...</p>
     </div>
    </div>
   </div>
  </div>
  <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
   <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
     <div class="jp-InputPrompt jp-InputArea-prompt">
     </div>
     <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <h2 id="Thoughts?">
       Thoughts?
       <a class="anchor-link" href="#Thoughts?"><i class="fa-solid fa-sm fa-link"></i></a>
      </h2>
     </div>
    </div>
   </div>
  </div>
  <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell">
   <div class="jp-Cell-inputWrapper">
    <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
    </div>
    <div class="jp-InputArea jp-Cell-inputArea">
     <div class="jp-InputPrompt jp-InputArea-prompt">
     </div>
     <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
      <p>As you can see, this can go unnoticed fairly easily. Due to the random nature of
the Gaussian processes (I use deterministic random numbers, but still the whole
outcome is "unknown" to me), it is really hard to know that there is a hidden
mathematical bug.</p>
      <p>I will probably add some <code>assert</code> statements here and there to make sure the
dimensions are always intended. Another way is to use type annotations like
<code>jaxtyping</code> instead of relying on static linters.</p>
     </div>
    </div>
   </div>
  </div>
 </section>
</section>

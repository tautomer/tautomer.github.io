<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">

<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-5TB54M0459"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'G-5TB54M0459');
  </script>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Uninstall immich dependencies script</title>
  <meta name="description" content="A script to uninstall immich dependencies.">

  <link rel="icon" type="image/png" sizes="192x192" href="/images/favicon/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png">

  <link href="/css/bootstrap.min.css" rel="stylesheet">
  <link href="/css/notebook.min.css" rel="stylesheet">
  <link href="/css/main.min.css" rel="stylesheet">
  <link href="/css/syntax.min.css" rel="stylesheet">
  <link href="/css/fontawesome-all.min.css" rel="stylesheet">

  <link rel="canonical" href="https://tautomer.github.io/">
</head>

<body>
  <nav class="navbar navbar-dark" style="background-color: #1e2227;">
    <div class="container-fluid">

      <button class="btn btn-lg" onclick="history.back()">
        <i class="text-secondary fa-solid fa-arrow-left"></i>
      </button>

      <button class="navbar-custom-toggler btn btn-outline-secondary dropdown-toggle order-0" type="button"
        data-bs-toggle="collapse" data-bs-target="#menuButton" aria-controls="menuButton" aria-expanded="false"
        aria-label="Toggle navigation">
        <span class="fa-solid fa-bars"></span>&nbsp;&nbsp; 昕旸's personal blog
      </button>

      <div class="collapse navbar-collapse order-3" id="menuButton">
        <div class="d-grid gap-2 d-md-block">
          <a href="/" class="nav-item btn btn-lg btn-outline-success navbar-custom-button"><span
              class="fa-solid fa-house"></span> Home</a>
          <a href="/tag_index" class="nav-item btn btn-lg btn-outline-primary navbar-custom-button"><span
              class="fa-solid fa-tags"></span> Tags</a>
          <a href="/posts_chrono" class="nav-item btn btn-lg btn-outline-post navbar-custom-button"><span
              class="fa-solid fa-clock-rotate-left"></span> Posts</a>
          <a href="/photography" class="nav-item btn btn-lg btn-outline-info navbar-custom-button"><span
              class="fa-solid fa-camera-retro"></span> Gallery</a>
          <a href="/about" class="nav-item btn btn-lg btn-outline-about navbar-custom-button"><span
              class="fa-solid fa-circle-info"></span> About</a>
        </div>
      </div>

      <div class="order-1" style="margin-right: 10px;">
        <div class="d-flex gap-2">
          <a href="https://www.linkedin.com/in/lxy-/" target="_blank" class="btn btn-lg" aria-label="LinkedIn"><i
              class="text-secondary fab fa-linkedin fa-lg"></i></a>
          <a href="https://github.com/tautomer" target="_blank" class="btn btn-lg" aria-label="GitHub"><i
              class="text-secondary fab fa-github fa-lg"></i></a>
          <a href="https://scholar.google.com/citations?hl=en&user=&view_op=list_works&sortby=pubdate"
            target="_blank" class="btn btn-lg" aria-label="Google Scholar"><i
              class="text-secondary fab fa-google-scholar fa-lg"></i></a>
          <a href="https://www.instagram.com/ringpolymer/" target="_blank" class="btn btn-lg" aria-label="Instagram"><i
              class="text-secondary fab fa-instagram fa-lg"></i></a>
          <a href="mailto:lix@lanl.gov" target="_blank" class="btn btn-lg" aria-label="Email"><i
              class="text-secondary fas fa-envelope fa-lg"></i></a>
        </div>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="main-template">
      <h1>
        <span class="fas fa-file fa-sm" aria-hidden="true"></span> Script for brutal-forced uninstallation of immich
        dependencies
      </h1>

      <ul>
        <li><a href="move_existing_immich_dependencies.sh" download>Direct download link to move_existing_immich_dependencies.sh</a></li>
      </ul>

      <p>Directly downloading a shell script can be dangerous, so please read the script below before running it.</p>

      <div class="highlight">
        <pre class="language-bash"><code>
#!/usr/bin/env bash

# This script reads file lists of existing entries and moves them from /usr/local
# to a consolidated backup location. It then cleans up the empty parent directories.
#
# It operates in two phases:
# 1. MOVE: Moves all files, symlinks, and special wildcarded groups (.so.*, vips-modules-*).
# 2. CLEANUP: Removes the now-empty parent directories from /usr/local.
#
# SAFETY: This script runs in DRY RUN mode by default.
# To perform the actual operations, run with the --live flag.

set -euo pipefail

# --- Configuration ---
LISTS_DIR="./stow_existing_lists"
BACKUP_DIR="$HOME/usr_local_backup_$(date +%Y-%m-%d)"

# Script Mode
DRY_RUN=true
if [[ "${1:-}" == "--live" ]]; then
  DRY_RUN=false
  echo "!!!!!!!! WARNING: LIVE MODE ENABLED. FILES WILL BE MOVED AND DIRECTORIES REMOVED. !!!!!!!!"
else
  echo "INFO: Running in DRY RUN mode. No changes will be made. Use --live to execute."
fi
sleep 2


if [ ! -d "$LISTS_DIR" ]; then
  echo "Error: Input directory with file lists not found at '$LISTS_DIR'."
  exit 1
fi

mkdir -p "$BACKUP_DIR"
echo "Backup destination: $BACKUP_DIR"
echo "--------------------------------------------------"

# Temp files for tracking state
processed_patterns_log=$(mktemp)
dirs_to_cleanup_log=$(mktemp)
trap 'rm -f -- "$processed_patterns_log" "$dirs_to_cleanup_log"' EXIT


# First, move files and symlinks
echo "PHASE 1: Moving all specified files and symlinks..."

for list_file in "$LISTS_DIR"/*-existing-entries.txt; do
  echo "Processing list: $(basename "$list_file")"
  while read -r entry_path || [[ -n "$entry_path" ]]; do

    pattern_to_move="$entry_path"

    # Wildcard handling
    if [[ "$entry_path" == *.so.* ]]; then
      pattern_to_move="${entry_path%%.so.*}.so.*"
    elif [[ "$entry_path" == *"/vips-modules-"* ]]; then
      pattern_to_move="${entry_path%%/vips-modules-*}/vips-modules-*"
    fi

    # Skip if already processed
    if grep -qFx "$pattern_to_move" "$processed_patterns_log"; then continue; fi
    echo "$pattern_to_move" >> "$processed_patterns_log"

    # Record parent directory for cleanup phase
    echo "$(dirname "$entry_path")" >> "$dirs_to_cleanup_log"

    # Prepare destination and move
    dest_parent_dir="$BACKUP_DIR/$(dirname "$entry_path")"

    if $DRY_RUN; then
      shopt -s nullglob
      found_items=0
      for item in $pattern_to_move; do
         if [ -e "$item" ] || [ -L "$item" ]; then
            echo "  [DRY RUN] Would move '$item' to '$dest_parent_dir/'"
            found_items=$((found_items + 1))
         fi
      done
      if [ $found_items -eq 0 ]; then
         echo "  [DRY RUN] Source not found (or already moved): '$pattern_to_move'"
      fi
      shopt -u nullglob
    else
      # Live mode
      shopt -s nullglob
      files_to_move=($pattern_to_move)
      shopt -u nullglob
      if [ ${#files_to_move[@]} -gt 0 ]; then
        echo "  -> Moving '$pattern_to_move' to '$dest_parent_dir/'"
        mkdir -p "$dest_parent_dir"
        mv -v $pattern_to_move "$dest_parent_dir/"
      else
        echo "  -> Source not found (or already moved): '$pattern_to_move'"
      fi
    fi
  done < "$list_file"
done


# Then cleanup empty parent directories
echo ""
echo "PHASE 2: Cleaning up empty parent directories..."

# Get a unique list of directories, sorted by longest path first (reverse sort)
# This ensures we try to remove child directories before their parents.
mapfile -t sorted_dirs < <(sort -r -u "$dirs_to_cleanup_log")

for dir_path in "${sorted_dirs[@]}"; do
  # Ensure we don't try to remove /usr/local itself or its direct children
  if [[ "$(echo "$dir_path" | tr -cd '/' | wc -c)" -le 3 ]]; then
      continue
  fi

  if $DRY_RUN; then
    if [ -d "$dir_path" ]; then
      echo "  [DRY RUN] Would attempt to remove empty directory '$dir_path'"
    fi
  else
    # Live mode
    if [ -d "$dir_path" ]; then
      # Use rmdir, which fails safely if the directory is not empty.
      # The "|| true" suppresses the error message for non-empty dirs.
      rmdir "$dir_path" 2>/dev/null || true
    fi
  fi
done


echo "--------------------------------------------------"
echo "Script finished."
if $DRY_RUN; then
  echo "Dry run complete. No changes were made."
else
  echo "Live run complete. Files have been moved to $BACKUP_DIR and empty directories cleaned."
fi
        </code></pre>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
    crossorigin="anonymous"></script>
</body>

</html>